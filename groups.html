{% extends "base.html" %}

{% block title %}Manage Groups - {{ panel_name }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <!-- Header -->
    <div class="card p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold">VPS Groups</h1>
                <p class="text-gray-600">Organize your VPS instances into groups for better management</p>
            </div>
            <button onclick="showCreateGroupModal()" 
                    class="btn-primary px-4 py-2 rounded-lg flex items-center space-x-2">
                <i class="fas fa-plus"></i>
                <span>Create Group</span>
            </button>
        </div>
    </div>

    <!-- Groups Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for group in groups %}
        <div class="card p-6 hover:shadow-lg transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-lg">{{ group.name }}</h3>
                <div class="flex space-x-2">
                    <button onclick="editGroup({{ group.id }}, '{{ group.name }}', '{{ group.description }}')"
                            class="text-blue-500 hover:text-blue-700">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteGroup({{ group.id }})"
                            class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <p class="text-gray-600 text-sm mb-4">{{ group.description or 'No description' }}</p>
            
            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-500">
                    {% set group_vps = vps_list|selectattr("groups", "equalto", group.id)|list %}
                    {{ group_vps|length }} VPS instances
                </span>
                <a href="#" onclick="showAssignModal({{ group.id }})" 
                   class="text-blue-500 hover:text-blue-700">
                    Manage
                </a>
            </div>
        </div>
        {% else %}
        <div class="col-span-full text-center py-12">
            <i class="fas fa-layer-group text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-600">No groups created yet</h3>
            <p class="text-gray-500 mt-2">Create your first group to organize VPS instances</p>
            <button onclick="showCreateGroupModal()" 
                    class="btn-primary mt-4 px-6 py-2 rounded-lg">
                Create Group
            </button>
        </div>
        {% endfor %}
    </div>

    <!-- Group VPS Overview -->
    {% if groups %}
    <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">VPS by Group</h2>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b">
                        <th class="text-left p-3">Group</th>
                        <th class="text-left p-3">VPS Count</th>
                        <th class="text-left p-3">Total Memory</th>
                        <th class="text-left p-3">Total CPU</th>
                        <th class="text-left p-3">Total Disk</th>
                        <th class="text-left p-3">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in groups %}
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-medium">{{ group.name }}</td>
                        <td class="p-3">
                            {% set group_vps = vps_list|selectattr("groups", "equalto", group.id)|list %}
                            {{ group_vps|length }}
                        </td>
                        <td class="p-3">
                            {% set group_vps = vps_list|selectattr("groups", "equalto", group.id)|list %}
                            {{ group_vps|sum(attribute='memory') }} GB
                        </td>
                        <td class="p-3">
                            {% set group_vps = vps_list|selectattr("groups", "equalto", group.id)|list %}
                            {{ group_vps|sum(attribute='cpu') }} Cores
                        </td>
                        <td class="p-3">
                            {% set group_vps = vps_list|selectattr("groups", "equalto", group.id)|list %}
                            {{ group_vps|sum(attribute='disk') }} GB
                        </td>
                        <td class="p-3">
                            <button onclick="showAssignModal({{ group.id }})"
                                    class="text-blue-500 hover:text-blue-700 text-sm">
                                Assign VPS
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Create Group Modal -->
<div id="createGroupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-xl font-semibold mb-4">Create New Group</h3>
        <form method="POST" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Group Name</label>
                <input type="text" name="name" required 
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea name="description" rows="3" 
                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideCreateGroupModal()"
                        class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    Cancel
                </button>
                <button type="submit" 
                        class="btn-primary px-4 py-2 rounded-lg">
                    Create Group
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Assign VPS Modal -->
<div id="assignVPSModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
        <h3 class="text-xl font-semibold mb-4">Assign VPS to Group</h3>
        <div class="max-h-96 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for vps in vps_list %}
                <div class="flex items-center justify-between p-3 border rounded-lg">
                    <div>
                        <div class="font-medium">{{ vps.vps_id }}</div>
                        <div class="text-sm text-gray-500">{{ vps.memory }}GB / {{ vps.cpu }}CPU</div>
                    </div>
                    <button onclick="assignVPSToGroup(vpsId, groupId)"
                            class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                        Assign
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="flex justify-end mt-4">
            <button onclick="hideAssignModal()"
                    class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                Close
            </button>
        </div>
    </div>
</div>

<script>
let currentGroupId = null;

function showCreateGroupModal() {
    document.getElementById('createGroupModal').classList.remove('hidden');
}

function hideCreateGroupModal() {
    document.getElementById('createGroupModal').classList.add('hidden');
}

function showAssignModal(groupId) {
    currentGroupId = groupId;
    document.getElementById('assignVPSModal').classList.remove('hidden');
}

function hideAssignModal() {
    document.getElementById('assignVPSModal').classList.add('hidden');
}

function editGroup(id, name, description) {
    // For simplicity, we'll just pre-fill the create modal
    const modal = document.getElementById('createGroupModal');
    const form = modal.querySelector('form');
    form.querySelector('input[name="name"]').value = name;
    form.querySelector('textarea[name="description"]').value = description;
    
    // Change form action to edit (you'd need to implement this endpoint)
    form.action = `/admin/group/${id}/edit`;
    modal.querySelector('h3').textContent = 'Edit Group';
    modal.querySelector('button[type="submit"]').textContent = 'Update Group';
    
    modal.classList.remove('hidden');
}

function deleteGroup(id) {
    if (confirm('Are you sure you want to delete this group? This will not delete the VPS instances.')) {
        // Implement delete functionality
        fetch(`/admin/group/${id}/delete`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error deleting group');
                }
            });
    }
}

function assignVPSToGroup(vpsId, groupId) {
    const formData = new FormData();
    formData.append('vps_id', vpsId);
    
    fetch(`/admin/group/${groupId}/assign`, {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            showCopySuccess('VPS assigned to group!');
            hideAssignModal();
        } else {
            alert('Error assigning VPS');
        }
    });
}

function showCopySuccess(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Close modals when clicking outside
document.addEventListener('click', (e) => {
    if (e.target.id === 'createGroupModal') {
        hideCreateGroupModal();
    }
    if (e.target.id === 'assignVPSModal') {
        hideAssignModal();
    }
});
</script>
{% endblock %}