{% extends "base.html" %}

{% block title %}{{ vps.vps_id }} - {{ panel_name }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="card p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold">{{ vps.vps_id }}</h1>
                <p class="text-gray-600">VPS Details & Management</p>
            </div>
            <div class="flex items-center space-x-3">
                <span class="status-{{ vps.status }} px-3 py-1 rounded-full text-sm font-medium">
                    <i class="fas fa-circle mr-1"></i>
                    {{ vps.status|title }}
                </span>
                <div class="flex space-x-2">
                    {% if vps.status == 'running' %}
                    <button onclick="stopVPS('{{ vps.vps_id }}')" 
                            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                        <i class="fas fa-stop mr-1"></i>Stop
                    </button>
                    <button onclick="restartVPS('{{ vps.vps_id }}')" 
                            class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition">
                        <i class="fas fa-redo mr-1"></i>Restart
                    </button>
                    {% else %}
                    <button onclick="startVPS('{{ vps.vps_id }}')" 
                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                        <i class="fas fa-play mr-1"></i>Start
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="stat-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Memory</p>
                    <p class="text-2xl font-bold">{{ vps.memory }} GB</p>
                </div>
                <i class="fas fa-memory text-3xl text-blue-500"></i>
            </div>
        </div>
        
        <div class="stat-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">CPU Cores</p>
                    <p class="text-2xl font-bold">{{ vps.cpu }}</p>
                </div>
                <i class="fas fa-microchip text-3xl text-green-500"></i>
            </div>
        </div>
        
        <div class="stat-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Disk Space</p>
                    <p class="text-2xl font-bold">{{ vps.disk }} GB</p>
                </div>
                <i class="fas fa-hdd text-3xl text-purple-500"></i>
            </div>
        </div>
        
        <div class="stat-card p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">SSH Port</p>
                    <p class="text-2xl font-bold">{{ vps.port }}</p>
                </div>
                <i class="fas fa-network-wired text-3xl text-orange-500"></i>
            </div>
        </div>
    </div>

    <!-- Connection Info -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-plug mr-2 text-blue-500"></i>
                Connection Information
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                    <span class="font-medium">VPS OS:</span>
                    <code class="bg-gray-100 px-2 py-1 rounded">{{ vps.os_image }}</code>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                    <span class="font-medium">SSH Host:</span>
                    <code class="bg-gray-100 px-2 py-1 rounded">{{ server_ip }}</code>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                    <span class="font-medium">SSH Port:</span>
                    <code class="bg-gray-100 px-2 py-1 rounded">{{ vps.port }}</code>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                    <span class="font-medium">Username:</span>
                    <code class="bg-gray-100 px-2 py-1 rounded">{{ vps.username }}</code>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                    <span class="font-medium">SSH:</span>
                    <code class="bg-gray-100 px-2 py-1 rounded">ssh root@{{ server_ip }} -p {{ vps.port }}</code>
                </div>
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                    <span class="font-medium">Tmate:</span>
                    <code class="bg-gray-100 px-2 py-1 rounded">{{ vps.tmate_session }}</code>
                </div>
                <div class="p-3 bg-gray-50 rounded">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">Password:</span>
                        <button onclick="togglePassword()" class="text-blue-500 text-sm">
                            <i class="fas fa-eye mr-1"></i>Show
                        </button>
                    </div>
                    <code id="passwordField" class="bg-gray-100 px-2 py-1 rounded hidden">{{ vps.password }}</code>
                </div>
            </div>
            
            <div class="mt-4 flex space-x-2">
                <button onclick="changePassword('{{ vps.vps_id }}')" 
                        class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">
                    <i class="fas fa-key mr-1"></i>Change Password
                </button>
                <a href="{{ url_for('vps_console', vps_id=vps.vps_id) }}" 
                   class="flex-1 bg-green-500 text-white py-2 rounded text-center hover:bg-green-600 transition">
                    <i class="fas fa-terminal mr-1"></i>Web Console
                </a>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card p-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fas fa-bolt mr-2 text-yellow-500"></i>
                Quick Actions
            </h3>
            <div class="grid grid-cols-2 gap-3">
                <a href="{{ url_for('vps_stats', vps_id=vps.vps_id) }}" 
                   class="p-4 bg-blue-50 rounded-lg text-center hover:bg-blue-100 transition">
                    <i class="fas fa-chart-bar text-blue-500 text-xl mb-2"></i>
                    <div class="font-medium">Statistics</div>
                </a>
                
                <a href="{{ url_for('vps_file_manager', vps_id=vps.vps_id) }}" 
                   class="p-4 bg-green-50 rounded-lg text-center hover:bg-green-100 transition">
                    <i class="fas fa-folder text-green-500 text-xl mb-2"></i>
                    <div class="font-medium">File Manager</div>
                </a>
                
                <a href="{{ url_for('vps_logs', vps_id=vps.vps_id) }}" 
                   class="p-4 bg-purple-50 rounded-lg text-center hover:bg-purple-100 transition">
                    <i class="fas fa-scroll text-purple-500 text-xl mb-2"></i>
                    <div class="font-medium">View Logs</div>
                </a>
                
                <a href="{{ url_for('vps_firewall', vps_id=vps.vps_id) }}" 
                   class="p-4 bg-red-50 rounded-lg text-center hover:bg-red-100 transition">
                    <i class="fas fa-shield-alt text-red-500 text-xl mb-2"></i>
                    <div class="font-medium">Firewall</div>
                </a>
            </div>
        </div>
    </div>

    <!-- Resource History Graph -->
    {% if history %}
    <div class="card p-6">
        <h3 class="text-lg font-semibold mb-4">Resource Usage History</h3>
        <div class="h-64">
            <canvas id="resourceChart"></canvas>
        </div>
    </div>
    {% endif %}
</div>

<script>
function togglePassword() {
    const field = document.getElementById('passwordField');
    const button = event.target;
    if (field.classList.contains('hidden')) {
        field.classList.remove('hidden');
        button.innerHTML = '<i class="fas fa-eye-slash mr-1"></i>Hide';
    } else {
        field.classList.add('hidden');
        button.innerHTML = '<i class="fas fa-eye mr-1"></i>Show';
    }
}

async function changePassword(vpsId) {
    if (!confirm('Are you sure you want to change the VPS password?')) return;
    
    const response = await fetch(`/vps/${vpsId}/change_password`, { method: 'POST' });
    const data = await response.json();
    
    if (response.ok) {
        alert('Password changed successfully: ' + data.password);
        location.reload();
    } else {
        alert('Error: ' + data.error);
    }
}

// Similar functions for start/stop/restart
async function startVPS(vpsId) {
    const response = await fetch(`/vps/${vpsId}/start`);
    if (response.ok) {
        location.reload();
    } else {
        const data = await response.json();
        alert('Error: ' + data.error);
    }
}

async function stopVPS(vpsId) {
    const response = await fetch(`/vps/${vpsId}/stop`);
    if (response.ok) {
        location.reload();
    } else {
        const data = await response.json();
        alert('Error: ' + data.error);
    }
}

async function restartVPS(vpsId) {
    const response = await fetch(`/vps/${vpsId}/restart`);
    if (response.ok) {
        location.reload();
    } else {
        const data = await response.json();
        alert('Error: ' + data.error);
    }
}

// Chart.js for resource history
{% if history %}
const ctx = document.getElementById('resourceChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ history|map(attribute='timestamp')|list|tojson }},
        datasets: [
            {
                label: 'CPU %',
                data: {{ history|map(attribute='cpu_percent')|list|tojson }},
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
            },
            {
                label: 'Memory %',
                data: {{ history|map(attribute='memory_percent')|list|tojson }},
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}